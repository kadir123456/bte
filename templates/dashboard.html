<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Paneli - Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .status-badge { font-size: 1rem; vertical-align: middle; }
        #logs { height: 400px; background-color: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 0.85rem; overflow-y: scroll; }
        .card-body-small-padding { padding: 1rem; }
        .table-sm td, .table-sm th { padding: .4rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Trading Bot Kontrol Paneli</a>
            <div class="d-flex">
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Çıkış Yap</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                Bot Durumu: <span id="bot-status-badge"></span>
                                | Aktif Sembol: <strong id="active-symbol-text">N/A</strong>
                            </h5>
                        </div>
                        <div>
                            <button id="start-bot-btn" class="btn btn-success">Stratejiyi Başlat</button>
                            <button id="stop-bot-btn" class="btn btn-warning">Stratejiyi Durdur</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4>Mevcut Pozisyon</h4></div>
                    <div class="card-body card-body-small-padding" id="position-info">
                        <p class="text-muted">Şu anda açık bir pozisyon bulunmuyor.</p>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4>Genel İstatistikler</h4></div>
                    <div class="card-body card-body-small-padding" id="stats-info">
                        Yükleniyor...
                    </div>
                </div>
                 <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4>Manuel İşlemler</h4></div>
                    <div class="card-body d-flex justify-content-around">
                        <button class="btn btn-success" onclick="manualTrade('LONG')">MANUEL LONG</button>
                        <button class="btn btn-danger" onclick="manualTrade('SHORT')">MANUEL SHORT</button>
                        <button class="btn btn-secondary" onclick="closePosition()">POZİSYONU KAPAT</button>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4>Bot Logları</h4></div>
                    <div class="card-body card-body-small-padding">
                        <div id="logs" class="p-2 rounded"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
             <div class="col-md-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4>Ayarlar</h4></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="symbol-select" class="form-label">İşlem Yapılacak Sembol</label>
                                <div class="input-group">
                                    <select class="form-select" id="symbol-select"></select>
                                    <button class="btn btn-outline-primary" onclick="updateSymbol()">Güncelle</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="leverage-input" class="form-label">Kaldıraç</label>
                                <input type="number" id="leverage-input" class="form-control" value="10">
                            </div>
                            <div class="col-md-4">
                                <label for="quantity-input" class="form-label">Miktar (USD)</label>
                                <div class="input-group">
                                    <input type="number" id="quantity-input" class="form-control" value="100">
                                    <button class="btn btn-outline-primary" onclick="updateSettings()">Kaydet</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-12">
                 <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4>İşlem Geçmişi</h4></div>
                    <div class="card-body">
                         <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Tarih</th><th>Sembol</th><th>Yön</th><th>PNL (USDT)</th><th>İşlem ID</th>
                                </tr>
                            </thead>
                            <tbody id="trades-history-body">
                                </tbody>
                         </table>
                    </div>
                 </div>
            </div>
        </div>
    </div>

<script>
    // --- ELEMENT REFERANSLARI ---
    const logContainer = document.getElementById('logs');
    const statusBadge = document.getElementById('bot-status-badge');
    const activeSymbolText = document.getElementById('active-symbol-text');
    const startBtn = document.getElementById('start-bot-btn');
    const stopBtn = document.getElementById('stop-bot-btn');
    const positionInfo = document.getElementById('position-info');
    const statsInfo = document.getElementById('stats-info');
    const symbolSelect = document.getElementById('symbol-select');
    const tradesHistoryBody = document.getElementById('trades-history-body');

    // --- API İSTEKLERİ ---
    async function postData(url, data = {}) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            return await response.json();
        } catch (error) {
            console.error('API isteği başarısız:', error);
        }
    }

    // --- KONTROL FONKSİYONLARI ---
    startBtn.addEventListener('click', () => postData('/start_bot'));
    stopBtn.addEventListener('click', () => postData('/stop_bot'));
    
    function manualTrade(side) {
        if (confirm(`${side} yönünde manuel işlem açmak istediğinize emin misiniz?`)) {
            postData('/manual_trade', { side: side });
        }
    }

    function closePosition() {
        if (confirm('Mevcut pozisyonu kapatmak istediğinize emin misiniz?')) {
            postData('/close_position');
        }
    }

    function updateSymbol() {
        const selectedSymbol = symbolSelect.value;
        postData('/update_symbol', { symbol: selectedSymbol });
    }

    function updateSettings() {
        const leverage = document.getElementById('leverage-input').value;
        const quantity_usd = document.getElementById('quantity-input').value;
        postData('/update_settings', { leverage: leverage, quantity_usd: quantity_usd });
    }

    // --- ARAYÜZ GÜNCELLEME FONKSİYONLARI ---
    function updateLogs(logs) {
        if (logs.length > 0) {
            logs.forEach(log => {
                const p = document.createElement('p');
                p.textContent = log;
                p.className = 'mb-0';
                logContainer.appendChild(p);
            });
            logContainer.scrollTop = logContainer.scrollHeight; // Otomatik aşağı kaydır
        }
    }

    function updateStatus(data) {
        // Bot durumu
        if (data.bot_status) {
            statusBadge.innerHTML = '<span class="badge bg-success status-badge">Çalışıyor</span>';
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } else {
            statusBadge.innerHTML = '<span class="badge bg-danger status-badge">Durdu</span>';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
        activeSymbolText.textContent = data.active_symbol;

        // Pozisyon bilgisi
        if (data.position) {
            const pos = data.position;
            const pnlClass = parseFloat(pos.pnl_usdt) >= 0 ? 'text-success' : 'text-danger';
            const side = parseFloat(pos.quantity) > 0 ? 'LONG' : 'SHORT';
            const sideClass = side === 'LONG' ? 'text-success' : 'text-danger';

            positionInfo.innerHTML = `
                <table class="table table-sm">
                    <tr><th>Sembol</th><td><strong>${pos.symbol} (${pos.leverage}x)</strong></td></tr>
                    <tr><th>Yön</th><td><strong class="${sideClass}">${side}</strong></td></tr>
                    <tr><th>Miktar</th><td>${pos.quantity}</td></tr>
                    <tr><th>Giriş Fiyatı</th><td>${pos.entry_price}</td></tr>
                    <tr><th>Anlık Fiyat</th><td>${pos.mark_price}</td></tr>
                    <tr><th>TP/SL</th><td>${pos.tp_price} / ${pos.sl_price}</td></tr>
                    <tr><th>PnL / ROI</th><td><strong class="${pnlClass}">${pos.pnl_usdt} USDT / ${pos.roi_percent}%</strong></td></tr>
                </table>
            `;
        } else {
            positionInfo.innerHTML = '<p class="text-muted">Şu anda açık bir pozisyon bulunmuyor.</p>';
        }

        // İstatistikler
        if(data.stats) {
            const stats = data.stats;
            const winRateClass = stats.win_rate >= 50 ? 'text-success' : 'text-danger';
            statsInfo.innerHTML = `
                <table class="table table-sm">
                    <tr><th>Toplam PNL</th><td><strong>${stats.total_pnl.toFixed(2)} USDT</strong></td></tr>
                    <tr><th>Kazanma Oranı</th><td><strong class="${winRateClass}">${stats.win_rate.toFixed(2)}%</strong></td></tr>
                    <tr><th>Kazanan / Kaybeden</th><td><span class="text-success">${stats.wins}</span> / <span class="text-danger">${stats.losses}</span></td></tr>
                    <tr><th>Toplam İşlem</th><td>${stats.total_trades}</td></tr>
                </table>
            `;
        }
        
        // İşlem Geçmişi
        if(data.all_trades && data.all_trades.length > 0) {
            tradesHistoryBody.innerHTML = ''; // Temizle
            data.all_trades.forEach(trade => {
                const pnlClass = trade[4] > 0 ? 'text-success' : 'text-danger';
                const date = new Date(trade[5]).toLocaleString('tr-TR');
                const row = `
                    <tr>
                        <td>${date}</td>
                        <td>${trade[1]}</td>
                        <td>${trade[3]}</td>
                        <td class="${pnlClass}">${trade[4].toFixed(2)}</td>
                        <td>${trade[2]}</td>
                    </tr>
                `;
                tradesHistoryBody.innerHTML += row;
            });
        }
    }
    
    // --- VERİ ÇEKME DÖNGÜSÜ ---
    async function fetchStatus() {
        try {
            const response = await fetch('/get_status');
            const data = await response.json();
            updateLogs(data.logs);
            updateStatus(data);
        } catch (error) {
            console.error('Durum güncellenemedi:', error);
        }
    }

    async function fetchAllSymbols() {
        try {
            const response = await fetch('/get_all_symbols');
            const data = await response.json();
            if(data.symbols) {
                symbolSelect.innerHTML = '';
                data.symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    symbolSelect.appendChild(option);
                });
                // Aktif sembolü seçili getir
                symbolSelect.value = activeSymbolText.textContent;
            }
        } catch (error) {
            console.error('Semboller çekilemedi:', error);
        }
    }

    // Sayfa yüklendiğinde ve sonrasında periyodik olarak veri çek
    document.addEventListener('DOMContentLoaded', () => {
        fetchStatus();
        fetchAllSymbols();
        setInterval(fetchStatus, 3000); // Her 3 saniyede bir durumu güncelle
    });
</script>

</body>
</html>
